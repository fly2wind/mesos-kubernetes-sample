---
- name: configure etcd upstart
  template: src="{{ item.src }}" dest="{{ item.dest }}" owner=root group=root mode=0644
  with_items:
    - { src: "default/etcd.j2",   dest: "/etc/default/etcd"   }
    - { src: "init/etcd.conf.j2", dest: "/etc/init/etcd.conf" }
  notify:
    - restart etcd

- name: register etcd service
  service: name=etcd state=started

- name: register etcd service with the consul agent
  consul: service_name=etcd service_port={{ etcd_client_port }} script="docker exec etcd etcdctl cluster-health" interval=60s timeout=2s

- include: skydns.yml
  when: cluster_dns is defined